<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>YouTube Playback App</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .grid-container {
            display: grid;
            grid-template-columns: 20% 80%;
            gap: 10px;
        }
        #player-container {
            max-width: 640px;
            margin: 0 auto;
        }
        button {
            margin-top: 10px;
        }
    </style>
    <!---
        ToDo
            - [x] Start Playback
            - [x] Stop (clear Timeout)
            - [x] Next
            - [ ] Back
            - [x] title, artist in segment data
            - [x] grid layout
            - [ ] list
            - [ ] use seekTime to go next (DO NOT use timeout)
            - [ ] load segment data from json file
    -->
</head>
<body>
    <h1>YouTube Playback App</h1>
    <div class="grid-container">
        <div id="control-pannel">
            <button id="start-playback">Start Playback</button>
            <button id="go-next">Next</button>
            <button id="stop-playback">Stop</button>
            <div id="current-segment-info"></div>
        </div>
        <div id="player-container">
            <div id="player"></div>
        </div>
    </div>
    <!--
    <div id="control-pannel">
        <button id="start-playback">Start Playback</button>
        <button id="go-next">Next</button>
        <button id="stop-playback">Stop</button>
        <div id="current-segment-info"></div>
    </div>
    --> 


    <script>
        let player;
        // let playbackData = [
        //     { startTime: 10, duration: 5 }, // 開始時間: 10秒、再生時間: 5秒
        //     { startTime: 30, duration: 10 },
        //     { startTime: 50, duration: 8 },
        // ];
        let playbackData = [
             { startTime: 152, endTime: 304, title: 'Drop', artist:'Team B', duration: 304 - 152 }, // Drop B 開始時間: xx秒、再生時間: x秒
             { startTime: 325, endTime: 477, title: 'Drop', artist:'Team A', duration: 477 - 325 }, // Drop A

             { startTime: 735, endTime: 1003, title: 'Pain is Beauty', artist:'MOMOKA', duration: 1003 - 735 }, // Pain is Beauty, MOMOKA
             { startTime: 1157, endTime: 1371, title: '花火', artist:'MAHINA', duration: 1371 - 1157 }, // 花火, MAHINA
             { startTime: 1511, endTime: 1731, title: 'TO HATERS', artist:'KOKONA', duration: 1731 - 1511 }, // TO HATERS, KOKONA
             { startTime: 1876, endTime: 2074, title: '美人', artist:'CHIKA', duration: 2074 - 1876 }, // 美人, CHIKA
             { startTime: 2208, endTime: 2479, title: 'In The Flames', artist:'FUMINO', duration: 2479 - 2208 }, // In The Flames, FUMINO

             { startTime: 2888, endTime: 3101, title: 'ディスタンス', artist:'KOHARU', duration: 3101 - 2888 }, // ディスタンス, KOHARU
             { startTime: 3296, endTime: 3601, title: 'ダリア', artist:'KOKO', duration: 3601 - 3296 }, // ダリア, KOKO
             { startTime: 3825, endTime: 4038, title: 'I\'m NOT OK', artist:'JISOO', duration: 4038 - 3825 }, // I'm NOT OK, JISOO
             { startTime: 4173, endTime: 4418, title: '^_^', artist:'NAOKO', duration: 4418 - 4173 }, // ^_^, NAOKO
             { startTime: 4605, endTime: 4886, title: 'ハレンチ', artist:'YURI', duration: 4886 - 4605 }, // ハレンチ, YURI
         ];
        let videoId = "hqrdKtyJuss"; // "dQw4w9WgXcQ"; // YouTube動画ID（ここを指定のURLから取得してください）
        let currentIndex = 0;
        let timerId = null;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '360',
                width: '640',
                videoId: videoId,
                events: {
                    onReady: onPlayerReady,
                    onStateChange: onPlayerStateChange,
                },
                playerVars: {
                    rel: 0, // 再生終了後に関連動画を表示するかどうか設定
                    autoplay: 0 // 自動再生するかどうか設定
                },
            });
        }

        function onPlayerReady(event) {
            document.getElementById("start-playback").addEventListener("click", startPlayback);
            document.getElementById("go-next").addEventListener("click", playNextSegment);
            document.getElementById("stop-playback").addEventListener("click", stopPlayback);
            player.addEventListener("timeupdate", checkSeekNext);

            //const embedCode = event.target.getVideoEmbedCode();
            //console.log(embedCode);
        }

        function onPlayerStateChange(event) {
            console.log("onPlayerStateChage(), event.data:", event.data);

            const state = event.data;
            switch(state) {
                case 1: // playing
                    timerId = setInterval(checkSeekNext, 1000);
                    break;
                case 0: // finish
                case 2: // stop
                    if(timerId) {
                        clearInterval(timerId);
                        timerId = null;
                    }
                    break;
            }
        }

        function showCurrentSegmentInfo() {
            let segment = playbackData[currentIndex];
            document.getElementById("current-segment-info").innerText = `Segment ${currentIndex + 1} / ${playbackData.length}: (${segment.title} , ${segment.artist})`;
        }

        function startPlayback() {
            if (playbackData.length === 0) return;
            currentIndex = 0;
            //playNextSegment();
            playSegment(currentIndex);
        }

        function stopPlayback() {
            if (timerId) {
                clearInterval(timerId);
                timerId = null;
            }
            player.pauseVideo();
        }

        function checkSeekNext() {
            console.log("timeupdate, checkSeekNext");
            const currentTime = player.getCurrentTime(); // 再生位置（秒単位）
            console.log('checkSeekNext() currentTime', currentTime);
            const segment = getCurrentSegment();
            const endTime = segment.endTime;
            if(currentTime <= endTime)
                return;

            playNextSegment();

            // player.pauseVideo();
            // currentIndex++;
            // if (currentIndex >= getSegmentCount()) {
            //     console.log("Playback finished.");
            //     return;
            // }
            // playSegment(currentIndex);
            // console.log("Go Next Segment");
        }

        function getCurrentSegment() {
            const segmentIndex = currentIndex;
            const segment = getSegment(currentIndex);
            return segment;
        }

        function getSegment(index) {
            return playbackData[index];
        }

        function getSegmentCount() {
            return playbackData.length;
        }

        function playSegment(index) {
            const segment = getSegment(index);
            if (!segment)
                return;

            player.seekTo(segment.startTime);
            player.playVideo();
            showCurrentSegmentInfo();     
        }

        function playNextSegment() {
            player.pauseVideo();
            currentIndex++;
            if (currentIndex >= getSegmentCount()) {
                console.log("Playback finished.");
                return;
            }
            playSegment(currentIndex);
            console.log("Go Next Segment");
        }

        // function playNextSegment() {
        //     if (timerId) {
        //         clearTimeout(timerId);
        //         timerId = null;
        //         currentIndex++;
        //         player.pauseVideo();
        //     }
        //     if (currentIndex >= playbackData.length) {
        //         console.log("Playback finished.");
        //         return;
        //     }

        //     console.log(`Playing segment ${currentIndex + 1} / ${playbackData.length}`);
        //     let segment = playbackData[currentIndex];
        //     player.seekTo(segment.startTime);
        //     player.playVideo();
        //     showCurrentSegmentInfo();
        //     const duration = segment.endTime - segment.startTime;

        //     timerId = setTimeout(() => {
        //         timerId = null;
        //         player.pauseVideo();
        //         currentIndex++;
        //         playNextSegment();
        //     }, duration * 1000);
        // }
    </script>
</body>
</html>
